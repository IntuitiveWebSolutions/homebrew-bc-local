# This file was generated by GoReleaser. DO NOT EDIT.
cask "bc-local-beta" do
  name "bc-local-beta"
  desc "Local BriteCore Dev Environment (Beta)"
  homepage ""
  version "0.15.0"

  livecheck do
    skip "Auto-generated on release."
  end

  binary "bc-local-beta"
  depends_on cask: [
      "podman-desktop",
    ],
    formula: [
      "awscli",
      "gettext",
      "gh",
      "go-task",
      "helm",
      "jq",
      "kind",
      "kubectl",
      "podman",
      "python@3.13",
      "sops",
      "uv",
      "yq",
    ]

  on_macos do
    on_intel do
      url "https://github.com/IntuitiveWebSolutions/bc-local/releases/download/v#{version}/bc-local-beta_#{version}_darwin_amd64.tar.gz",
        header: [
          "Accept: application/octet-stream",
          "Authorization: bearer #{GitHub::API.credentials}",
        ]
      sha256 "dabce15c13d2c0f8a3870ca5bb8f05bb621cecaf6172ea27ddc0ee9ce942b4a2"
    end
    on_arm do
      url "https://github.com/IntuitiveWebSolutions/bc-local/releases/download/v#{version}/bc-local-beta_#{version}_darwin_arm64.tar.gz",
        header: [
          "Accept: application/octet-stream",
          "Authorization: bearer #{GitHub::API.credentials}",
        ]
      sha256 "70e4b25162a6b36562a654319ec0238844b927d634866d3761b4b195a27061b2"
    end
  end

  on_linux do
    on_intel do
      url "https://github.com/IntuitiveWebSolutions/bc-local/releases/download/v#{version}/bc-local-beta_#{version}_linux_amd64.tar.gz",
        header: [
          "Accept: application/octet-stream",
          "Authorization: bearer #{GitHub::API.credentials}",
        ]
      sha256 "4ca91a1d7b70aa7254b2411364dae7ba882de10906cae25b9d3ee843785d8ec3"
    end
    on_arm do
      url "https://github.com/IntuitiveWebSolutions/bc-local/releases/download/v#{version}/bc-local-beta_#{version}_linux_arm64.tar.gz",
        header: [
          "Accept: application/octet-stream",
          "Authorization: bearer #{GitHub::API.credentials}",
        ]
      sha256 "a3d85a2d997b2d784d246578dfe4b2bb974c8b9ab3efd0fd556b82eeff3f48c0"
    end
  end

  postflight do
    ENV['PATH'] = "/opt/homebrew/bin:/usr/local/bin:~/.local/bin:#{ENV['PATH']}"

    if system_command("/usr/bin/xattr", args: ["-h"]).exit_status == 0
      system_command "/bin/chmod", args: ["+x", "#{staged_path}/scripts/db-connect.sh"]
      system_command "/usr/bin/xattr", args: ["-dr", "com.apple.quarantine", "#{staged_path}/bc-local-beta"]
    end

    # Check if britecore-cli is already installed
    if !File.executable?("#{Dir.home}/.local/bin/britecore-cli")
      puts "britecore-cli not found, installing..."

      # Find task binary in common locations
      task_binary = nil
      ["/opt/homebrew/bin/task", "/usr/local/bin/task", "/usr/bin/task"].each do |path|
        if File.executable?(path)
          task_binary = path
          break
        end
      end

      if task_binary
        puts "Using task binary at: #{task_binary}"
        system_command task_binary, args: ["-t", "#{staged_path}/Taskfile.yaml", "install-cli"]
      else
        puts "Warning: task binary not found. Please install go-task and run 'task install-cli' manually."
      end
    else
      puts "britecore-cli already installed at ~/.local/bin/britecore-cli"
    end
  end

  # No zap stanza required
end
